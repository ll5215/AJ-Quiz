<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Question Detail</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/card-detail.css">
</head>
<body class="font-sans">
    <div class="container mx-auto px-4 py-8 bg-white max-w-lg">
        <div class="flex items-center justify-between mb-4 nav">
            <a href="{{ url_for('main') }}"><img class="nav-img" src="/static/logo.png" alt="AJ"></a>
            <a href="{{ url_for('mypage') }}">
                <h2 class="text-xl font-semibold">{{ username }} <span class="text-sm font-semibold">님</span></h2>
            </a>
        </div>
        <div class="bg-gray-100 p-4 rounded-lg mb-8 card-wrap">
            <span class="block text-right text-gray-500 text-xs" id="view-count">조회수: </span>
            <div class="text-center mb-4">
                <h3 class="text-lg font-medium" id="question"></h3>
                <br>
                <img id="result-image" src="/static/wrong.png" alt="X" class="mx-auto">
                <br>
                <p class="text-lg font-semibold" id="correct-answer">정답: </p>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-gray-500 text-xs">작성자: {{ username }}</span>
            </div>
        </div>
        <div class="answer-wrap">
            <h3 class="text-lg font-semibold mb-4">다른 답변들</h3>
            <div class="answers-wrap">
              <div id="other-answers"></div>
            </div>
        </div>
        <button class="fixed bottom-8 right-8 bg-gray-900 text-white text-lg p-4 rounded-full shadow-lg hover:bg-gray-700 focus:outline-none">
            작성
        </button>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const question = params.get('question');
            const answer = params.get('answer');
            const userAnswer = params.get('user_answer');
            const views = params.get('views');
            const correct = params.get('correct') === 'true';
            const questionId = params.get('question_id');

            document.getElementById('question').textContent = question;
            document.getElementById('correct-answer').textContent = `정답: ${answer}`;
            document.getElementById('view-count').textContent = `조회수: ${views}`;
            
            if (correct) {
                document.getElementById('result-image').src = '/static/signiture.png';
            } else {
                document.getElementById('result-image').src = '/static/wrong.png';
            }

            fetch(`/get-question-answers/${questionId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const otherAnswersContainer = document.getElementById('other-answers');
                        otherAnswersContainer.innerHTML = ''; // 기존 답변 삭제
                        data.answers.forEach(answer => {
                            const answerElement = document.createElement('div');
                            answerElement.className = 'bg-gray-100 p-4 rounded-lg mb-4';
                            const heartIcon = answer.liked ? '/static/heart-filled.png' : '/static/heart-empty.png';
                            answerElement.innerHTML = `
                                <p>${answer.answer}</p>
                                <div class="flex justify-between items-center mt-2">
                                    <span class="text-gray-500 text-xs">작성자: ${answer.user}</span>
                                    <span class="flex items-center text-red-500">
                                        <a href="javascript:void(0)" class="like-button" data-id="${answer._id}">
                                            <img class="heart" src="${heartIcon}" />
                                        </a>
                                        <span class="ml-1 like-count">${answer.likes}</span>
                                    </span>
                                </div>
                            `;
                            otherAnswersContainer.appendChild(answerElement);
                        });

                        // 이벤트 리스너 추가
                        document.querySelectorAll('.like-button').forEach(button => {
                            button.addEventListener('click', function() {
                                const answerId = this.getAttribute('data-id');
                                const likeCountElement = this.nextElementSibling;
                                const heartImage = this.querySelector('.heart');
                                const isLiked = heartImage.src.includes('heart-filled.png');
                                
                                const url = isLiked ? '/unlike-answer' : '/like-answer';
                                fetch(url, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ answer_id: answerId })
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        likeCountElement.textContent = data.likes;
                                        heartImage.src = isLiked ? '/static/heart-empty.png' : '/static/heart-filled.png';
                                    } else {
                                        console.error('Failed to update likes');
                                    }
                                })
                                .catch(error => console.error('Error:', error));
                            });
                        });
                    } else {
                        console.error('Failed to fetch answers');
                    }
                })
                .catch(error => console.error('Error:', error));
        });
    </script>
</body>
</html>
